{{ define "habit-modal" }}
<!-- Add modal markup starts here -->

<div x-show="modalState.isOpen" 
x-cloak
class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
@click="closeModal()">
<div class="bg-white rounded-lg p-8 w-11/12 max-w-2xl" 
    @click.stop>
   <!-- Header -->
   <div class="flex justify-between items-center mb-6">
       <h2 class="text-2xl font-bold">Create a Habit</h2>
       <button @click="closeModal()" class="text-gray-500 hover:text-gray-700">
           <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg>
       </button>
   </div>

   <!-- Suggestions View -->
   <div x-show="modalState.view === 'suggestions'">
       <!-- Create Your Own -->
       <button 
           @click="modalState.view = 'custom'"
           class="w-full mb-4 px-4 py-3 rounded-full border-2 border-gray-300 hover:border-gray-400 flex items-center justify-center space-x-2 transition-colors duration-200">
           <span>‚ú®</span>
           <span>Create your own habit</span>
       </button>

       <!-- Habit Suggestions -->
       <div class="flex flex-wrap gap-3 mb-8">
           <template x-for="suggestion in habitSuggestions.slice(1)" :key="suggestion.name">
               <button 
                   @click="modalState.selectedHabit = modalState.selectedHabit === suggestion.name ? null : suggestion.name"
                   :class="{
                       'bg-[#e6f4ea] text-[#2da44e] border-[#2da44e]': modalState.selectedHabit === suggestion.name,
                       'bg-white text-gray-700 border-gray-300 hover:border-gray-400': modalState.selectedHabit !== suggestion.name
                   }"
                   class="px-4 py-2 rounded-full border transition-colors duration-200">
                   <span x-text="suggestion.emoji"></span>
                   <span x-text="suggestion.name" class="ml-2"></span>
               </button>
           </template>
       </div>

       <!-- Footer Buttons -->
       <div class="flex justify-end space-x-4 mt-8">
           <button 
               @click="closeModal()"
               class="px-4 py-2 rounded-md bg-gray-300 text-gray-700 hover:bg-gray-200 transition-colors duration-200">
               Cancel ‚ùå
           </button>
           <button 
               @click="
                   if (modalState.selectedHabit) {
                       const suggestion = habitSuggestions.find(s => s.name === modalState.selectedHabit);
                       if (suggestion) {
                           fetch('/api/habits', {
                               method: 'POST',
                               headers: {
                                   'Content-Type': 'application/json',
                               },
                               body: JSON.stringify({
                                   name: suggestion.name,
                                   emoji: suggestion.emoji,
                                   habit_type: suggestion.type
                               })
                           })
                           .then(response => response.json())
                           .then(result => {
                               if (result.success) {
                                   habits.push(result.data);
                                   habits.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
                                   closeModal();
                                   flashMessage = result.message;
                                   showFlash = true;
                                   setTimeout(() => showFlash = false, 3000);
                               } else {
                                   flashMessage = result.message;
                                   showFlash = true;
                                   setTimeout(() => showFlash = false, 3000);
                               }
                           })
                           .catch(error => {
                               flashMessage = 'Error creating habit';
                               showFlash = true;
                               setTimeout(() => showFlash = false, 3000);
                           });
                       }
                   }
               "
               :disabled="!modalState.selectedHabit"
               :class="{'opacity-50 cursor-not-allowed': !modalState.selectedHabit}"
               class="px-4 py-2 rounded-md bg-[#2da44e] text-white hover:bg-[#2c974b] transition-colors duration-200">
               Create Habit ‚ú®
           </button>
       </div>
   </div>

   <!-- Custom Habit View -->
   <div x-show="modalState.view === 'custom'" class="space-y-6">
       <!-- Main Emoji and Name Row -->
       <div class="grid grid-cols-2 gap-4 mt-6">
           <!-- Emoji Selector -->
           <div class="relative">
               <label class="block text-sm font-medium text-gray-700 mb-1">Choose Habit Icon</label>
               <div class="relative">
                   <input 
                       type="text"
                       x-model="emojiSearch"
                       @input="searchEmojis()"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                       placeholder="Search emoji..."
                   >
                   <!-- Selected Emoji Display -->
                   <div x-show="modalState.customHabit.emoji" 
                        class="absolute right-2 top-1/2 -translate-y-1/2 text-xl">
                       <span x-text="modalState.customHabit.emoji"></span>
                   </div>
               </div>

               <!-- Emoji Search Results (smaller and contained) -->
               <div 
                   x-show="emojiResults.length > 0"
                   class="absolute z-50 mt-1 w-full bg-white border rounded-md shadow-lg max-h-40 overflow-y-auto">
                   <div class="grid grid-cols-6 gap-1 p-2">
                       <template x-for="emoji in emojiResults" :key="emoji.id">
                           <button 
                               @click="
                                   modalState.customHabit.emoji = emoji.skins[0].native;
                                   emojiResults = [];
                                   emojiSearch = '';
                               "
                               class="p-1.5 text-lg hover:bg-gray-100 rounded-md"
                               :title="emoji.name">
                               <span x-text="emoji.skins[0].native"></span>
                           </button>
                       </template>
                   </div>
               </div>
           </div>

           <!-- Habit Name Input -->
           <div>
               <label class="block text-sm font-medium text-gray-700 mb-1">Habit Name</label>
               <input 
                   type="text"
                   x-model="modalState.customHabit.name"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                   placeholder="Enter habit name..."
               >
           </div>
       </div>

       <!-- Type Selection -->
       <div class="grid grid-cols-3 gap-4">
           <!-- Binary Card -->
           <button 
               @click="modalState.customHabit.type = 'binary'"
               :class="{
                   'ring-2 ring-[#2da44e]': modalState.customHabit.type === 'binary',
                   'hover:border-gray-400': modalState.customHabit.type !== 'binary'
               }"
               class="p-4 border rounded-lg text-center transition-all">
               <div class="text-2xl mb-2">‚úÖ</div>
               <h3 class="font-semibold mb-2">Binary</h3>
               <p class="text-sm text-gray-600">Did you do it or not?</p>
           </button>

           <!-- Numeric Card -->
           <button 
               @click="modalState.customHabit.type = 'numeric'"
               :class="{
                   'ring-2 ring-[#2da44e]': modalState.customHabit.type === 'numeric',
                   'hover:border-gray-400': modalState.customHabit.type !== 'numeric'
               }"
               class="p-4 border rounded-lg text-center transition-all">
               <div class="text-2xl mb-2">üî¢</div>
               <h3 class="font-semibold mb-2">Numeric</h3>
               <p class="text-sm text-gray-600">Track a number (e.g., pages read)</p>
           </button>

           <!-- Option-Select Card -->
           <button 
               @click="modalState.customHabit.type = 'option-select'"
               :class="{
                   'ring-2 ring-[#2da44e]': modalState.customHabit.type === 'option-select',
                   'hover:border-gray-400': modalState.customHabit.type !== 'option-select'
               }"
               class="p-4 border rounded-lg text-center transition-all">
               <div class="text-2xl mb-2">üé®</div>
               <h3 class="font-semibold mb-2">Emoji Choice</h3>
               <p class="text-sm text-gray-600">Select from predefined emoji options</p>
           </button>
       </div>

       <!-- Option-Select Fields -->
       <div x-show="modalState.customHabit.type === 'option-select'" 
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            class="mt-6 space-y-4">
           <h4 class="text-sm font-medium text-gray-700">Emoji Options</h4>
           <p class="text-sm text-gray-500">Add multiple emoji/label pairs.</p>

           <!-- Search for emoji to add as an option -->
           <div class="relative">
               <input 
                   type="text"
                   x-model="optionEmojiSearch"
                   @input="searchOptionEmojis()"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                   placeholder="Search emoji to add..."
               >

               <!-- Option Emoji Results -->
               <div 
                   x-show="optionEmojiResults.length > 0"
                   class="absolute z-50 mt-1 w-full bg-white border rounded-md shadow-lg max-h-60 overflow-y-auto">
                   <div class="grid grid-cols-8 gap-1 p-2">
                       <template x-for="emoji in optionEmojiResults" :key="emoji.id">
                           <button 
                               @click="
                                   selectedOptionEmoji = emoji.skins[0].native;
                                   optionEmojiResults = [];
                                   optionEmojiSearch = '';
                               "
                               class="p-2 text-xl hover:bg-gray-100 rounded-md"
                               :title="emoji.name">
                               <span x-text="emoji.skins[0].native"></span>
                           </button>
                       </template>
                   </div>
               </div>
           </div>

           <!-- After selecting an emoji, add a label -->
           <div class="flex items-center gap-2" x-show="selectedOptionEmoji">
               <span class="text-2xl" x-text="selectedOptionEmoji"></span>
               <input 
                   type="text"
                   x-model="selectedOptionLabel"
                   @keyup.enter="addOption()"
                   class="flex-1 border px-2 py-1 rounded-md"
                   placeholder="Label for this option..."
               >
               <button 
                   @click="addOption()"
                   class="px-3 py-1 bg-[#2da44e] text-white rounded-md hover:bg-[#2c974b]">
                   Add Option
               </button>
           </div>

           <!-- Display current options -->
           <div class="border rounded-md p-4">
               <h5 class="text-sm font-medium text-gray-700 mb-2">Current Options:</h5>
               <template x-for="(opt, index) in modalState.customHabit.habitOptions" :key="index">
                   <div class="flex items-center gap-2 mb-2 p-2 bg-gray-50 rounded">
                       <span x-text="opt.emoji" class="text-2xl"></span>
                       <span x-text="opt.label" class="text-sm text-gray-700 flex-1"></span>
                       <button 
                           @click="removeOption(index)"
                           class="text-red-500 hover:text-red-700">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                           </svg>
                       </button>
                   </div>
               </template>
               <div x-show="!modalState.customHabit.habitOptions?.length" class="text-sm text-gray-500 text-center py-2">
                   No options added yet.
               </div>
           </div>
       </div>

       <!-- Footer Buttons -->
       <div class="flex justify-between space-x-4 mt-8">
           <!-- Back Button -->
           <button 
               @click="modalState.view = 'suggestions'"
               class="px-4 py-2 rounded-md bg-[#00a0d2] text-white hover:bg-[#008db8] transition-colors duration-200">
               ‚Üê Back
           </button>
           
           <div class="flex space-x-4">
               <button 
                   @click="closeModal()"
                   class="px-4 py-2 rounded-md bg-gray-300 text-gray-700 hover:bg-gray-200 transition-colors duration-200">
                   Cancel ‚ùå
               </button>
               <button 
                   @click="createCustomHabit()"
                   :disabled="!modalState.customHabit.name || !modalState.customHabit.type || !modalState.customHabit.emoji"
                   :class="{'opacity-50 cursor-not-allowed': !modalState.customHabit.name || !modalState.customHabit.type || !modalState.customHabit.emoji}"
                   class="px-4 py-2 rounded-md bg-[#2da44e] text-white hover:bg-[#2c974b] transition-colors duration-200">
                   Create Habit ‚ú®
               </button>
           </div>
       </div>
   </div>
</div>
</div>
{{ end }} 
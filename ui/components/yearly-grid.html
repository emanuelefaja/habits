{{ define "yearly-grid" }}
<div x-data="yearlyGrid" class="flex justify-center mt-8">
    <div class="bg-white p-8 shadow sm:rounded-lg w-full">
        <!-- Add year navigation -->
        <div class="flex items-center gap-3 mb-6">
            <span class="isolate inline-flex rounded-md shadow-sm">
                <button type="button" 
                        class="relative inline-flex items-center rounded-l-md bg-white px-1.5 py-1.5 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10"
                        @click="previousYear">
                    <span class="sr-only">Previous Year</span>
                    <svg class="size-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button type="button"
                        class="relative -ml-px inline-flex items-center rounded-r-md bg-white px-1.5 py-1.5 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10"
                        @click="nextYear">
                    <span class="sr-only">Next Year</span>
                    <svg class="size-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </span>
            <h2 class="text-2xl font-semibold">üóìÔ∏è <span x-text="currentYear"></span></h2>
        </div>
        <div class="overflow-auto">
            <div class="flex flex-col">
                <!-- Month labels row -->
                <div class="flex items-center mb-2">
                    <div style="width: 30px;"></div>
                    <div class="flex" style="width: calc(100% - 30px);">
                        <template x-for="(month, mIndex) in monthNames" :key="'month-'+mIndex">
                            <div x-show="getMonthStartWeek(mIndex) !== -1"
                                 :style="{ 
                                     width: getMonthWidth(mIndex),
                                     marginLeft: mIndex === 0 ? '0' : '',
                                     borderLeft: mIndex !== 0 ? '1px solid #eee' : ''
                                 }"
                                 class="text-center text-xs font-semibold"
                                 x-text="month">
                            </div>
                        </template>
                    </div>
                </div>
    
                <!-- Days + Grid -->
                <div class="flex">
                    <!-- Day Labels -->
                    <div class="flex flex-col justify-center">
                        <template x-for="(dayLabel, index) in ['M', 'T', 'W', 'T', 'F', 'S', 'S']" :key="index">
                            <div class="flex items-center justify-center text-sm font-medium text-gray-300"
                                 style="height: 17px; margin-bottom: 3px; width: 30px; margin-right: 8px; line-height: 15px;">
                                <span x-text="dayLabel"></span>
                            </div>
                        </template>
                    </div>
    
                    <!-- Year Heatmap Grid -->
                    <div class="flex">
                        <template x-for="(week, wIndex) in weeks" :key="'week-'+wIndex">
                            <div class="flex flex-col mr-1">
                                <template x-for="(day, dIndex) in week" :key="'day-'+wIndex+'-'+dIndex">
                                    <div :class="{
                                            'bg-transparent cursor-default': day === null,
                                            'transition-transform duration-150 hover:-translate-y-0.5 cursor-pointer': day !== null
                                         }"
                                         @click="(() => {
                                             if (day === null) return;
                                             const dateStr = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
                                             const currentStatus = getStatus(day);
                                             let newStatus = 'done';
                                             
                                             // Cycle through states
                                             switch(currentStatus) {
                                                 case 'none': newStatus = 'done'; break;
                                                 case 'done': newStatus = 'missed'; break;
                                                 case 'missed': newStatus = 'skipped'; break;
                                                 case 'skipped': newStatus = 'none'; break;
                                             }
                                             
                                             fetch('/api/habits/logs', {
                                                 method: 'POST',
                                                 headers: { 'Content-Type': 'application/json' },
                                                 body: JSON.stringify({
                                                     habit_id: {{ .Habit.ID }},
                                                     date: dateStr,
                                                     status: newStatus
                                                 })
                                             })
                                             .then(res => res.json())
                                             .then(result => {
                                                 if (result.success) {
                                                     habitLogs[dateStr] = {
                                                         habit_id: {{ .Habit.ID }},
                                                         date: dateStr,
                                                         status: newStatus
                                                     };
                                                 }
                                             });
                                         })()"
                                         :style="{ 
                                             backgroundColor: day ? getStatusColor(getStatus(day)) : 'transparent'
                                         }"
                                         style="width: 17px; height: 17px; margin-bottom: 3px; border-radius: 2px;">
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex justify-center gap-6 mt-6">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-sm" style="background-color: #2da44e;"></div>
                <span class="text-sm text-gray-600">Done</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-sm" style="background-color: #E3211a;"></div>
                <span class="text-sm text-gray-600">Missed</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-sm" style="background-color: #00a0d2;"></div>
                <span class="text-sm text-gray-600">Skipped</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-sm" style="background-color: #ebedf0;"></div>
                <span class="text-sm text-gray-600">No Data</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('yearlyGrid', () => ({
        dayLabels: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
        monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        weeks: [],
        currentYear: new Date().getFullYear(),
        habitLogs: {},

        init() {
            this.generateYearDays(this.currentYear);
            this.loadYearData();
        },

        generateYearDays(year) {
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year + 1, 0, 1);

            // Get to the first Monday before or on January 1st
            let currentDate = new Date(startDate.getTime());
            while (currentDate.getDay() !== 1) { // 1 represents Monday
                currentDate.setDate(currentDate.getDate() - 1);
            }

            let allWeeks = [];
            let firstWeek = true;

            while (currentDate < endDate) {
                let weekDays = [];
                for (let i = 0; i < 7; i++) {
                    if (currentDate < startDate && firstWeek) {
                        weekDays.push(null); // Hide days before January 1st
                    } else if (currentDate < endDate) {
                        weekDays.push(new Date(currentDate));
                    } else {
                        weekDays.push(null);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                allWeeks.push(weekDays);
                firstWeek = false;
            }

            this.weeks = allWeeks;
        },

        getMonthStartWeek(monthIndex) {
            return this.weeks.findIndex(week => 
                week.some(day => day && day.getMonth() === monthIndex)
            );
        },

        getMonthWidth(monthIndex) {
            const daysInMonth = new Date(this.currentYear, monthIndex + 1, 0).getDate();
            const totalDays = this.weeks.flat().filter(day => day !== null).length;
            return `${(daysInMonth / totalDays) * 100}%`;
        },

        loadYearData() {
            const startDate = `${this.currentYear}-01-01`;
            const endDate = `${this.currentYear}-12-31`;
            
            fetch(`/api/habits/logs?habit_id={{ .Habit.ID }}&start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(result => {
                    // Reset habitLogs
                    this.habitLogs = {};
                    
                    // Process the logs into a lookup object
                    if (result.success && Array.isArray(result.data)) {
                        result.data.forEach(log => {
                            // Convert the date to YYYY-MM-DD format for lookup
                            const key = log.date.split('T')[0];
                            this.habitLogs[key] = log;
                        });
                    } else {
                        console.error('Invalid response format:', result);
                    }
                })
                .catch(error => {
                    console.error('Error loading year data:', error);
                });
        },

        getStatus(date) {
            if (!date) return 'none';
            
            // Format date as YYYY-MM-DD
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            return this.habitLogs[dateStr]?.status || 'none';
        },

        getStatusColor(status) {
            const colors = {
                'done': '#2da44e',
                'missed': '#E3211a',
                'skipped': '#00a0d2',
                'none': '#ebedf0'
            };
            return colors[status] || colors.none;
        },

        previousYear() {
            this.currentYear--;
            this.generateYearDays(this.currentYear);
            this.loadYearData();
        },

        nextYear() {
            this.currentYear++;
            this.generateYearDays(this.currentYear);
            this.loadYearData();
        }
    }));
});
</script>
{{ end }}
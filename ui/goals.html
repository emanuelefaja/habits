<!DOCTYPE html>
<html lang="en" class="min-h-full bg-gray-50 dark:bg-gray-900">
{{ template "head" . }}
<body class="min-h-full bg-gray-50 dark:bg-gray-900" x-data="{ 
    loading: true,
    gridLayout: localStorage.getItem('goalsGridLayout') === 'false' ? false : true,
    showCreateGoal: false,
    habits: [],
    goals: [],
    newGoal: {
        habitId: '',
        name: '',
        startDate: new Date().toISOString().split('T')[0],
        endDate: '',
        targetNumber: ''
    },
    statusFilters: (() => {
        try {
            const defaultFilters = {
                'on_track': true,
                'at_risk': true,
                'off_track': true,
                'done': true,
                'failed': true
            };
            const stored = localStorage.getItem('goalsStatusFilters');
            if (!stored) return defaultFilters;
            
            const parsedFilters = JSON.parse(stored);
            // Ensure all required filters exist
            return {
                ...defaultFilters,
                ...parsedFilters
            };
        } catch (e) {
            console.error('Error loading status filters:', e);
            return {
                'on_track': true,
                'at_risk': true,
                'off_track': true,
                'done': true,
                'failed': true
            };
        }
    })(),
    async loadHabits() {
        try {
            const response = await fetch('/api/habits');
            const result = await response.json();
            if (result.success) {
                this.habits = result.data;
            }
        } catch (error) {
            console.error('Error loading habits:', error);
        }
    },
    async loadGoals() {
        try {
            this.loading = true;
            const response = await fetch('/api/goals');
            const result = await response.json();
            if (result.success) {
                this.goals = result.data.map(goal => ({
                    ...goal,
                    current_number: parseFloat(goal.current_number),
                    target_number: parseFloat(goal.target_number)
                }));
            }
        } catch (error) {
            console.error('Error loading goals:', error);
        } finally {
            this.loading = false;
        }
    },
    get isValidGoal() {
        
        return this.newGoal.name && 
               this.newGoal.habitId &&
               this.newGoal.targetNumber > 0 && 
               this.newGoal.endDate && 
               new Date(this.newGoal.endDate) > new Date(this.newGoal.startDate);
    },
    async createGoal() {
        if (!this.isValidGoal) return;
        
        const goalData = {
            habit_id: parseInt(this.newGoal.habitId),
            name: this.newGoal.name,
            start_date: this.newGoal.startDate,
            end_date: this.newGoal.endDate,
            target_number: parseFloat(this.newGoal.targetNumber)
        };

        try {
            const response = await fetch('/api/goals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(goalData)
            });

            const result = await response.json();
            if (result.success) {
                await this.loadGoals();
                this.showCreateGoal = false;
                // Reset form
                this.newGoal = {
                    habitId: '',
                    name: '',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: '',
                    targetNumber: ''
                };
            }
        } catch (error) {
            console.error('Error creating goal:', error);
        }
    },
    saveFilters() {
        try {
            localStorage.setItem('goalsStatusFilters', JSON.stringify(this.statusFilters));
        } catch (e) {
            console.error('Error saving status filters:', e);
        }
    }
}"
x-init="loadHabits(); loadGoals()"
@goal-deleted="loadGoals()"
@goal-updated="loadGoals()">
    {{ template "header" dict "User" .User "Page" "goals" }}
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="flex justify-between items-start">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">🎯 Goals</h1>
                <button 
                    @click="gridLayout = !gridLayout; localStorage.setItem('goalsGridLayout', gridLayout)"
                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                    x-text="gridLayout ? '⬇️' : '➡️'"
                ></button>
            </div>
            <div class="flex items-center gap-4">
                <!-- Status Filter Buttons -->
                <div class="flex gap-2">
                    <button
                        @click="statusFilters.on_track = !statusFilters.on_track; saveFilters()"
                        class="inline-flex items-center rounded-md px-2 py-1 text-sm ring-1 ring-inset transition-colors"
                        :class="statusFilters.on_track ? 'bg-green-50 text-green-700 ring-green-600/20 dark:bg-green-900/50 dark:text-green-200' : 'bg-gray-50 text-gray-600 ring-gray-500/20 dark:bg-gray-800 dark:text-gray-400'">
                        🎯 On Track
                    </button>
                    <button
                        @click="statusFilters.at_risk = !statusFilters.at_risk; saveFilters()"
                        class="inline-flex items-center rounded-md px-2 py-1 text-sm ring-1 ring-inset transition-colors"
                        :class="statusFilters.at_risk ? 'bg-orange-50 text-orange-700 ring-orange-600/20 dark:bg-orange-900/50 dark:text-orange-200' : 'bg-gray-50 text-gray-600 ring-gray-500/20 dark:bg-gray-800 dark:text-gray-400'">
                        👀 At Risk
                    </button>
                    <button
                        @click="statusFilters.off_track = !statusFilters.off_track; saveFilters()"
                        class="inline-flex items-center rounded-md px-2 py-1 text-sm ring-1 ring-inset transition-colors"
                        :class="statusFilters.off_track ? 'bg-red-50 text-red-700 ring-red-600/20 dark:bg-red-900/50 dark:text-red-200' : 'bg-gray-50 text-gray-600 ring-gray-500/20 dark:bg-gray-800 dark:text-gray-400'">
                        🚨 Off Track
                    </button>
                    <button
                        @click="statusFilters.done = !statusFilters.done; saveFilters()"
                        class="inline-flex items-center rounded-md px-2 py-1 text-sm ring-1 ring-inset transition-colors"
                        :class="statusFilters.done ? 'bg-[#2da44e]/20 text-[#2da44e] ring-[#2da44e]/20 dark:bg-[#2da44e]/30 dark:text-[#4fff7f]' : 'bg-gray-50 text-gray-600 ring-gray-500/20 dark:bg-gray-800 dark:text-gray-400'">
                        ✅ Done
                    </button>
                    <button
                        @click="statusFilters.failed = !statusFilters.failed; saveFilters()"
                        class="inline-flex items-center rounded-md px-2 py-1 text-sm ring-1 ring-inset transition-colors"
                        :class="statusFilters.failed ? 'bg-red-100 text-red-800 ring-red-600/20 dark:bg-red-900/50 dark:text-red-200' : 'bg-gray-50 text-gray-600 ring-gray-500/20 dark:bg-gray-800 dark:text-gray-400'">
                        ❌ Failed
                    </button>
                </div>
                <button 
                    @click="showCreateGoal = true"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[#2da44e] hover:bg-[#2c974b] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2da44e]">
                    Create Goal 🎯 
                </button>
            </div>
        </div>

        <!-- Loading state -->
        <div x-show="loading" class="mt-6 flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#2da44e]"></div>
        </div>

        <!-- Content container -->
        <div x-show="!loading" :class="{ 'hidden': loading }">
            <!-- Grid container - wraps all goal cards -->
            <div 
                class="mt-6 grid gap-6"
                :class="gridLayout ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2'">
                
                <!-- Empty State -->
                <template x-if="!loading && goals.filter(goal => goal.status && statusFilters[goal.status]).length === 0">
                    <div class="flex-grow flex items-center justify-center col-span-full py-12">
                        <div class="flex flex-col items-start gap-4">
                            <h2 class="text-xl text-gray-600 dark:text-gray-400 font-medium ml-2">
                                A goal without a plan is just a wish.
                            </h2>
                            </h2>
                            
                            <div class="flex items-center gap-16">
                                <button 
                                    @click="showCreateGoal = true"
                                    class="px-6 py-3 text-lg rounded-lg bg-[#2da44e] text-white hover:bg-[#2c974b] transition-colors duration-200 flex items-center gap-2">
                                    <span>Create Goal</span>
                                    <span>🎯</span>
                                </button>
                                
                                <div class="text-9xl">
                                    👀
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Dynamic Goal Cards -->
                <template x-for="goal in goals.filter(goal => goal.status && statusFilters[goal.status])" :key="goal.id">
                    {{ template "goal" . }}
                </template>
            </div>
        </div>
    </div>

    <!-- Create Goal Modal -->
    <div 
        x-show="showCreateGoal" 
        x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click="showCreateGoal = false">

        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl" @click.stop>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">✨ Create New Goal</h2>
                <button @click="showCreateGoal = false" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Goal Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Goal Name</label>
                    <input 
                        type="text" 
                        x-model="newGoal.name"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white"
                        placeholder="Enter your goal">
                </div>

                <!-- Habit Selection -->
                <div x-data="{
                    selectOpen: false,
                    selectedItem: null,
                    selectableItems: [],
                    selectableItemActive: null,
                    selectId: $id('habit-select'),
                    selectKeydownValue: '',
                    selectKeydownTimeout: 1000,
                    selectKeydownClearTimeout: null,
                    selectDropdownPosition: 'bottom',
                    
                    // Initialize items from habits
                    initItems() {
                        this.selectableItems = habits.filter(h => h.habit_type !== 'option-select').map(habit => ({
                            title: `${habit.emoji} ${habit.name}`,
                            value: habit.id,
                            disabled: false,
                            habit: habit
                        }));
                    },
                    
                    selectableItemIsActive(item) {
                        return this.selectableItemActive && this.selectableItemActive.value == item.value;
                    },
                    selectableItemActiveNext(){
                        let index = this.selectableItems.indexOf(this.selectableItemActive);
                        if(index < this.selectableItems.length-1){
                            this.selectableItemActive = this.selectableItems[index+1];
                            this.selectScrollToActiveItem();
                        }
                    },
                    selectableItemActivePrevious(){
                        let index = this.selectableItems.indexOf(this.selectableItemActive);
                        if(index > 0){
                            this.selectableItemActive = this.selectableItems[index-1];
                            this.selectScrollToActiveItem();
                        }
                    },
                    selectScrollToActiveItem(){
                        if(this.selectableItemActive){
                            activeElement = document.getElementById(this.selectableItemActive.value + '-' + this.selectId)
                            newScrollPos = (activeElement.offsetTop + activeElement.offsetHeight) - this.$refs.selectableItemsList.offsetHeight;
                            if(newScrollPos > 0){
                                this.$refs.selectableItemsList.scrollTop=newScrollPos;
                            } else {
                                this.$refs.selectableItemsList.scrollTop=0;
                            }
                        }
                    },
                    selectKeydown(event){
                        if (event.keyCode >= 65 && event.keyCode <= 90) {
                            this.selectKeydownValue += event.key;
                            selectedItemBestMatch = this.selectItemsFindBestMatch();
                            if(selectedItemBestMatch){
                                if(this.selectOpen){
                                    this.selectableItemActive = selectedItemBestMatch;
                                    this.selectScrollToActiveItem();
                                } else {
                                    this.selectedItem = this.selectableItemActive = selectedItemBestMatch;
                                }
                            }
                            
                            if(this.selectKeydownValue != ''){
                                clearTimeout(this.selectKeydownClearTimeout);
                                this.selectKeydownClearTimeout = setTimeout(() => {
                                    this.selectKeydownValue = '';
                                }, this.selectKeydownTimeout);
                            }
                        }
                    },
                    selectItemsFindBestMatch(){
                        typedValue = this.selectKeydownValue.toLowerCase();
                        var bestMatch = null;
                        var bestMatchIndex = -1;
                        for (var i = 0; i < this.selectableItems.length; i++) {
                            var title = this.selectableItems[i].title.toLowerCase();
                            var index = title.indexOf(typedValue);
                            if (index > -1 && (bestMatchIndex == -1 || index < bestMatchIndex) && !this.selectableItems[i].disabled) {
                                bestMatch = this.selectableItems[i];
                                bestMatchIndex = index;
                            }
                        }
                        return bestMatch;
                    },
                    selectPositionUpdate(){
                        selectDropdownBottomPos = this.$refs.selectButton.getBoundingClientRect().top + this.$refs.selectButton.offsetHeight + parseInt(window.getComputedStyle(this.$refs.selectableItemsList).maxHeight);
                        if(window.innerHeight < selectDropdownBottomPos){
                            this.selectDropdownPosition = 'top';
                        } else {
                            this.selectDropdownPosition = 'bottom';
                        }
                    },
                    selectHabit(item) {
                        this.selectedItem = item;
                        newGoal.habitId = item.value;
                        this.selectOpen = false;
                    }
                }"
                x-init="
                    initItems();
                    $watch('selectOpen', function(){
                        if(!selectedItem && selectableItems.length > 0){ 
                            selectableItemActive = selectableItems[0];
                        } else {
                            selectableItemActive = selectedItem;
                        }
                        setTimeout(function(){
                            selectScrollToActiveItem();
                        }, 10);
                        selectPositionUpdate();
                        window.addEventListener('resize', (event) => { selectPositionUpdate(); });
                    });
                    $watch('habits', function() {
                        initItems();
                    });
                "
                @keydown.escape="if(selectOpen){ selectOpen=false; }"
                @keydown.down="if(selectOpen){ selectableItemActiveNext(); } else { selectOpen=true; } event.preventDefault();"
                @keydown.up="if(selectOpen){ selectableItemActivePrevious(); } else { selectOpen=true; } event.preventDefault();"
                @keydown.enter="if(selectableItemActive){ selectHabit(selectableItemActive); }"
                @keydown="selectKeydown($event);"
                class="relative w-full">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Habit</label>
                    
                    <button x-ref="selectButton" @click="selectOpen=!selectOpen"
                        :class="{ 'focus:ring-2 focus:ring-offset-2 focus:ring-[#2da44e]' : !selectOpen }"
                        class="relative min-h-[38px] flex items-center justify-between w-full py-2 pl-3 pr-10 text-left bg-white dark:bg-gray-700 border rounded-md shadow-sm cursor-default border-gray-300 dark:border-gray-600 focus:outline-none text-sm text-gray-900 dark:text-white">
                        <span x-text="selectedItem ? selectedItem.title : 'Select a habit...'" class="truncate" :class="{ 'text-gray-400 dark:text-gray-500': !selectedItem }">Select a habit...</span>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="w-5 h-5 text-gray-400"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z" clip-rule="evenodd"></path></svg>
                        </span>
                    </button>

                    <ul x-show="selectOpen"
                        x-ref="selectableItemsList"
                        @click.away="selectOpen = false"
                        x-transition:enter="transition ease-out duration-50"
                        x-transition:enter-start="opacity-0 -translate-y-1"
                        x-transition:enter-end="opacity-100"
                        :class="{ 'bottom-0 mb-10' : selectDropdownPosition == 'top', 'top-0 mt-10' : selectDropdownPosition == 'bottom' }"
                        class="absolute z-10 w-full py-1 mt-1 overflow-auto text-sm bg-white dark:bg-gray-700 rounded-md shadow-lg max-h-60 ring-1 ring-black/5 dark:ring-white/5 focus:outline-none"
                        x-cloak>

                        <template x-for="item in selectableItems" :key="item.value">
                            <li 
                                @click="selectHabit(item); $refs.selectButton.focus();"
                                :id="item.value + '-' + selectId"
                                :data-disabled="item.disabled"
                                :class="{ 'bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white' : selectableItemIsActive(item), 'text-gray-700 dark:text-gray-200' : !selectableItemIsActive(item) }"
                                @mousemove="selectableItemActive=item"
                                class="relative flex items-center h-full py-2 pl-8 cursor-default select-none data-[disabled]:opacity-50 data-[disabled]:pointer-events-none hover:bg-gray-100 dark:hover:bg-gray-600">
                                <svg x-show="selectedItem && selectedItem.value==item.value" class="absolute left-0 w-4 h-4 ml-2 stroke-current text-[#2da44e]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                <span class="block font-medium truncate" x-text="item.title"></span>
                            </li>
                        </template>
                    </ul>
                </div>

                <!-- Target Value -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target Value</label>
                    <input 
                        type="number" 
                        x-model="newGoal.targetNumber"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white"
                        placeholder="Enter target value">
                </div>

                <!-- Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Date</label>
                        <div x-data="{
                            datePickerOpen: false,
                            datePickerValue: newGoal.startDate,
                            datePickerFormat: 'YYYY-MM-DD',
                            datePickerMonth: '',
                            datePickerYear: '',
                            datePickerDay: '',
                            datePickerDaysInMonth: [],
                            datePickerBlankDaysInMonth: [],
                            datePickerMonthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                            datePickerDays: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                            init() {
                                if (this.newGoal.startDate) {
                                    const [year, month, day] = this.newGoal.startDate.split('-');
                                    this.datePickerYear = parseInt(year);
                                    this.datePickerMonth = parseInt(month) - 1;
                                    this.datePickerDay = parseInt(day);
                                } else {
                                    const currentDate = new Date();
                                    this.datePickerMonth = currentDate.getMonth();
                                    this.datePickerYear = currentDate.getFullYear();
                                }
                                this.datePickerCalculateDays();
                            },
                            datePickerDayClicked(day) {
                                const selectedDate = new Date(this.datePickerYear, this.datePickerMonth, day);
                                this.datePickerValue = this.datePickerFormatDate(selectedDate);
                                this.datePickerOpen = false;
                            },
                            datePickerPreviousMonth() {
                                if (this.datePickerMonth === 0) {
                                    this.datePickerYear--;
                                    this.datePickerMonth = 11;
                                } else {
                                    this.datePickerMonth--;
                                }
                                this.datePickerCalculateDays();
                            },
                            datePickerNextMonth() {
                                if (this.datePickerMonth === 11) {
                                    this.datePickerYear++;
                                    this.datePickerMonth = 0;
                                } else {
                                    this.datePickerMonth++;
                                }
                                this.datePickerCalculateDays();
                            },
                            datePickerIsSelectedDate(day) {
                                const d = new Date(this.datePickerYear, this.datePickerMonth, day);
                                return this.datePickerValue === this.datePickerFormatDate(d);
                            },
                            datePickerIsToday(day) {
                                const today = new Date();
                                const d = new Date(this.datePickerYear, this.datePickerMonth, day);
                                return today.toDateString() === d.toDateString();
                            },
                            datePickerCalculateDays() {
                                const daysInMonth = new Date(this.datePickerYear, this.datePickerMonth + 1, 0).getDate();
                                const dayOfWeek = new Date(this.datePickerYear, this.datePickerMonth).getDay();
                                this.datePickerBlankDaysInMonth = Array.from({length: dayOfWeek}, (_, i) => i + 1);
                                this.datePickerDaysInMonth = Array.from({length: daysInMonth}, (_, i) => i + 1);
                            },
                            datePickerFormatDate(date) {
                                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                                return formattedDate;
                            }
                        }" 
                        x-modelable="datePickerValue" 
                        x-model="newGoal.startDate">
                            <div class="relative w-full">
                                <input x-ref="datePickerInput" 
                                    type="text" 
                                    @click="datePickerOpen = !datePickerOpen" 
                                    x-model="datePickerValue" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" 
                                    readonly>
                                <div class="absolute top-0 right-0 px-3 py-2 cursor-pointer text-gray-400" @click="datePickerOpen = !datePickerOpen">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div x-show="datePickerOpen" x-cloak 
                                    class="absolute z-10 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 w-full">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <span x-text="datePickerMonthNames[datePickerMonth]" class="text-sm font-semibold dark:text-white"></span>
                                            <span x-text="datePickerYear" class="ml-1 text-sm dark:text-gray-300"></span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button @click="datePickerPreviousMonth()" class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                </svg>
                                            </button>
                                            <button @click="datePickerNextMonth()" class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        <template x-for="day in datePickerDays" :key="day">
                                            <div class="text-center text-xs font-medium text-gray-600 dark:text-gray-400" x-text="day"></div>
                                        </template>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1">
                                        <template x-for="blankDay in datePickerBlankDaysInMonth">
                                            <div class="text-center"></div>
                                        </template>
                                        <template x-for="day in datePickerDaysInMonth" :key="day">
                                            <button @click="datePickerDayClicked(day)"
                                                class="w-8 h-8 rounded-full text-sm flex items-center justify-center transition-colors"
                                                :class="{
                                                    'bg-[#2da44e] text-white': datePickerIsSelectedDate(day),
                                                    'text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700': !datePickerIsSelectedDate(day),
                                                    'font-semibold': datePickerIsToday(day)
                                                }">
                                                <span x-text="day"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Repeat the same structure for End Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Date</label>
                        <div x-data="{
                            datePickerOpen: false,
                            datePickerValue: newGoal.endDate,
                            datePickerFormat: 'YYYY-MM-DD',
                            datePickerMonth: '',
                            datePickerYear: '',
                            datePickerDay: '',
                            datePickerDaysInMonth: [],
                            datePickerBlankDaysInMonth: [],
                            datePickerMonthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                            datePickerDays: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                            init() {
                                if (this.newGoal.endDate) {
                                    const [year, month, day] = this.newGoal.endDate.split('-');
                                    this.datePickerYear = parseInt(year);
                                    this.datePickerMonth = parseInt(month) - 1;
                                    this.datePickerDay = parseInt(day);
                                } else {
                                    const currentDate = new Date();
                                    this.datePickerMonth = currentDate.getMonth();
                                    this.datePickerYear = currentDate.getFullYear();
                                }
                                this.datePickerCalculateDays();
                            },
                            datePickerDayClicked(day) {
                                const selectedDate = new Date(this.datePickerYear, this.datePickerMonth, day);
                                this.datePickerValue = this.datePickerFormatDate(selectedDate);
                                this.datePickerOpen = false;
                            },
                            datePickerPreviousMonth() {
                                if (this.datePickerMonth === 0) {
                                    this.datePickerYear--;
                                    this.datePickerMonth = 11;
                                } else {
                                    this.datePickerMonth--;
                                }
                                this.datePickerCalculateDays();
                            },
                            datePickerNextMonth() {
                                if (this.datePickerMonth === 11) {
                                    this.datePickerYear++;
                                    this.datePickerMonth = 0;
                                } else {
                                    this.datePickerMonth++;
                                }
                                this.datePickerCalculateDays();
                            },
                            datePickerIsSelectedDate(day) {
                                const d = new Date(this.datePickerYear, this.datePickerMonth, day);
                                return this.datePickerValue === this.datePickerFormatDate(d);
                            },
                            datePickerIsToday(day) {
                                const today = new Date();
                                const d = new Date(this.datePickerYear, this.datePickerMonth, day);
                                return today.toDateString() === d.toDateString();
                            },
                            datePickerCalculateDays() {
                                const daysInMonth = new Date(this.datePickerYear, this.datePickerMonth + 1, 0).getDate();
                                const dayOfWeek = new Date(this.datePickerYear, this.datePickerMonth).getDay();
                                this.datePickerBlankDaysInMonth = Array.from({length: dayOfWeek}, (_, i) => i + 1);
                                this.datePickerDaysInMonth = Array.from({length: daysInMonth}, (_, i) => i + 1);
                            },
                            datePickerFormatDate(date) {
                                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                                return formattedDate;
                            }
                        }" 
                        x-modelable="datePickerValue" 
                        x-model="newGoal.endDate">
                            <div class="relative w-full">
                                <input x-ref="datePickerInput" 
                                    type="text" 
                                    @click="datePickerOpen = !datePickerOpen" 
                                    x-model="datePickerValue" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" 
                                    readonly>
                                <div class="absolute top-0 right-0 px-3 py-2 cursor-pointer text-gray-400" @click="datePickerOpen = !datePickerOpen">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div x-show="datePickerOpen" x-cloak 
                                    class="absolute z-10 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 w-full">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <span x-text="datePickerMonthNames[datePickerMonth]" class="text-sm font-semibold dark:text-white"></span>
                                            <span x-text="datePickerYear" class="ml-1 text-sm dark:text-gray-300"></span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button @click="datePickerPreviousMonth()" class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                </svg>
                                            </button>
                                            <button @click="datePickerNextMonth()" class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        <template x-for="day in datePickerDays" :key="day">
                                            <div class="text-center text-xs font-medium text-gray-600 dark:text-gray-400" x-text="day"></div>
                                        </template>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1">
                                        <template x-for="blankDay in datePickerBlankDaysInMonth">
                                            <div class="text-center"></div>
                                        </template>
                                        <template x-for="day in datePickerDaysInMonth" :key="day">
                                            <button @click="datePickerDayClicked(day)"
                                                class="w-8 h-8 rounded-full text-sm flex items-center justify-center transition-colors"
                                                :class="{
                                                    'bg-[#2da44e] text-white': datePickerIsSelectedDate(day),
                                                    'text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700': !datePickerIsSelectedDate(day),
                                                    'font-semibold': datePickerIsToday(day)
                                                }">
                                                <span x-text="day"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Buttons -->
            <div class="mt-6 flex justify-end space-x-3">
                <button 
                    @click="showCreateGoal = false"
                    class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md">
                    Cancel
                </button>
                <button 
                    @click="createGoal()"
                    class="px-4 py-2 text-sm font-medium text-white bg-[#2da44e] hover:bg-[#2c974b] rounded-md"
                    :class="{ 'opacity-50 cursor-not-allowed': !isValidGoal }">
                    Create Goal 🎯 
                </button>
            </div>
        </div>
    </div>

    {{ template "footer" . }}
</body>
</html> 
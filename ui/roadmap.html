<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roadmap - Habits</title>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .smooth-scroll {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="h-full">
    {{ template "header" dict "User" .User "Page" "roadmap" }}

    <!-- Roadmap component -->
    <div x-data="roadmap({{ if .User }}true{{ else }}false{{ end }})">
        <!-- Mobile scroll indicator -->
        <div class="p-4 text-center text-sm text-gray-500 lg:hidden">
            Scroll horizontally to see more columns →
        </div>

        <!-- Main container -->
        <div class="p-6 overflow-x-auto smooth-scroll">
            <div class="flex lg:grid lg:grid-cols-4 gap-4 min-w-max lg:min-w-0">
                <template x-for="column in columns" :key="column.title">
                    <div class="bg-white rounded-lg shadow p-4 w-80 lg:w-auto">
                        <h2 class="text-lg font-semibold mb-4" x-text="column.title"></h2>
                        <div class="space-y-3">
                            <!-- Special Submit Idea card for Ideas column -->
                            <template x-if="column.title === 'Ideas 💡'">
                                <div @click="openIdeaModal()" 
                                     class="bg-[#e6f4ea] rounded-lg p-4 border-2 border-dashed border-[#2da44e] hover:bg-[#d3ebda] transition-colors duration-200 cursor-pointer">
                                    <div class="flex items-start space-x-3">
                                        <div class="text-2xl">✨</div>
                                        <div>
                                            <h3 class="font-medium">Submit Your Idea</h3>
                                            <p class="text-sm text-gray-600 mt-1">Share your feature suggestions with us!</p>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Regular cards -->
                            <template x-for="card in column.cards" :key="card.id">
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-[#2da44e] transition-colors duration-200 relative">
                                    <!-- Like button -->
                                    <button 
                                        @click="isAuthenticated && column.title !== 'Done ✨' && toggleLike(card.id)"
                                        :class="!isAuthenticated || column.title === 'Done ✨' ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'"
                                        class="absolute top-2 right-2 flex items-center space-x-1"
                                        :title="!isAuthenticated ? 'Sign in to vote on features' : ''">
                                        <span class="text-sm text-gray-600" x-text="getLikeCount(card.id)"></span>
                                        <span class="text-xl" x-text="isLiked(card.id) ? '💖' : '🤍'"></span>
                                    </button>

                                    <!-- Card content -->
                                    <div class="flex items-start space-x-3">
                                        <div class="text-2xl" x-text="card.emoji"></div>
                                        <div>
                                            <h3 class="font-medium" x-text="card.title"></h3>
                                            <p class="text-sm text-gray-600 mt-1" x-text="card.description"></p>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('roadmap', (isAuthenticated = false) => ({
                columns: [
                    {
                        title: 'Ideas 💡',
                        cards: [
                            { id: 'mobile-app', emoji: '📱', title: 'Mobile App', description: 'Native mobile application for iOS and Android' },
                            { id: 'dark-mode', emoji: '🌙', title: 'Dark Mode', description: 'System-wide dark mode support' },
                            { id: 'advanced-analytics', emoji: '📊', title: 'Advanced Analytics', description: 'Detailed insights and progress tracking' },
                            { id: 'public-api', emoji: '🔌', title: 'Public API', description: 'REST API for integrating with other services' },
                            { id: 'visual-editor', emoji: '📋', title: 'Visual Editor', description: 'Visual editor for editing habits in a table' },
                            { id: 'notifications', emoji: '🔔', title: 'Notifications', description: 'Custom reminders and notifications' }
                        ]
                    },
                    {
                        title: 'Planned 🎯',
                        cards: [
                            { id: 'weekend-highlighting', emoji: '📅', title: 'Weekend Highlighting', description: 'Highlight weekend days in monthly grid view' },
                            { id: 'habit-streaks', emoji: '📈', title: 'Habit Streaks', description: 'Track consecutive days of habits' },
                            { id: 'notes-journaling', emoji: '📝', title: 'Notes & Journaling', description: 'Add notes to habit entries' },
                            { id: 'responsive-design', emoji: '📱', title: 'Responsive Design', description: 'Works on all screen sizes' },
                            { id: 'goals', emoji: '🎯', title: 'Goals', description: 'Set and track progress towards habit goals' },
                            { id: 'full-pwa', emoji: '📱', title: 'Full PWA', description: 'Full Progressive Web App with offline support' },
                            { id: 'chrome-extension', emoji: '🔌', title: 'Chrome Extension', description: 'Extension to open habits in new tab automatically' },
                            { id: 'public-roadmap', emoji: '🌐', title: 'Public Roadmap', description: 'Make roadmap visible to guests without login' }
                        ]
                    },
                    {
                        title: 'In Progress 🚧',
                        cards: [
                            { id: 'mood-tracking', emoji: '😊', title: 'Mood Tracking', description: 'Track daily mood with customizable emoji reactions' },
                            { id: 'set-rep-habits', emoji: '💪', title: 'Set+Rep Habits', description: 'Track exercises with sets, reps and weight' },
                            { id: 'submit-ideas', emoji: '💡', title: 'Submit Ideas', description: 'Submit your own ideas for the roadmap' }
                        ]
                    },
                    {
                        title: 'Done ✨',
                        cards: [
                            { id: 'monthly-view', emoji: '📊', title: 'Monthly View', description: 'Calendar view of habits' },
                            { id: 'numeric-habits', emoji: '🔢', title: 'Numeric Habits', description: 'Track habits with numbers' },
                            { id: 'binary-habits', emoji: '✅', title: 'Binary Habits', description: 'Simple yes/no habit tracking' },
                            { id: 'heart-likes', emoji: '❤️', title: 'Heart Likes', description: 'Vote on roadmap features with heart likes' },
                            { id: 'user-settings', emoji: '⚙️', title: 'User Settings', description: 'Update name, email and password.' },
                            { id: 'roadmap', emoji: '🗺️', title: 'Roadmap', description: 'Public roadmap page showing planned features' },
                            { id: 'csv-export', emoji: '📥', title: 'CSV Export', description: 'Download habit data as CSV' },
                            { id: 'sortable-habits', emoji: '↕️', title: 'Sortable Habits', description: 'Drag and drop to reorder habits in the grid' },
                            { id: 'options-habits', emoji: '🗳️', title: 'Options Habits', description: 'Select from a list of options' }
                        ]
                    }
                ],
                likes: {},
                loading: {},
                isAuthenticated,
                
                async init() {
                    console.log('Initializing roadmap...');
                    try {
                        console.log('Fetching initial likes data...');
                        const response = await fetch('/api/roadmap/likes');
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        console.log('Received likes data:', data);
                        this.likes = data.reduce((acc, like) => {
                            acc[like.cardId] = {
                                count: like.totalLikes,
                                liked: like.userLiked
                            };
                            return acc;
                        }, {});
                        console.log('Processed likes data:', this.likes);
                    } catch (error) {
                        console.error('Failed to fetch likes:', error);
                    }
                },
                
                async toggleLike(cardId) {
                    console.log('Toggle like clicked for card:', cardId);
                    if (this.loading[cardId]) {
                        console.log('Already processing like for card:', cardId);
                        return;
                    }
                    
                    console.log('Current likes state:', this.likes[cardId]);
                    const oldState = { ...this.likes[cardId] };
                    if (!this.likes[cardId]) {
                        console.log('First like for card:', cardId);
                        this.likes[cardId] = { count: 1, liked: true };
                    } else {
                        this.likes[cardId].liked = !this.likes[cardId].liked;
                        this.likes[cardId].count += this.likes[cardId].liked ? 1 : -1;
                        console.log('Updated likes state:', this.likes[cardId]);
                    }
                    
                    this.loading[cardId] = true;
                    console.log('Set loading state for card:', cardId);
                    
                    try {
                        console.log('Sending POST request to toggle like...');
                        const response = await fetch('/api/roadmap/likes', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ cardId }),
                        });
                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('Received response data:', data);
                        this.likes[cardId] = {
                            count: data.totalLikes,
                            liked: data.userLiked
                        };
                        console.log('Updated likes with server data:', this.likes[cardId]);
                    } catch (error) {
                        console.error('Failed to toggle like:', error);
                        console.log('Reverting to old state:', oldState);
                        this.likes[cardId] = oldState;
                        alert('Failed to update like. Please try again.');
                    } finally {
                        this.loading[cardId] = false;
                        console.log('Cleared loading state for card:', cardId);
                    }
                },

                getLikeCount(cardId) {
                    return this.likes[cardId]?.count || 0;
                },

                isLiked(cardId) {
                    return this.likes[cardId]?.liked || false;
                },

                handleLikeClick(cardId) {
                    if (!this.isAuthenticated) {
                        window.location.href = '/login?redirect=/roadmap';
                        return;
                    }
                    if (this.loading[cardId]) return;
                    this.toggleLike(cardId);
                }
            }));
        });
    </script>
</body>
</html> 
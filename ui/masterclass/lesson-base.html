<!DOCTYPE html>
<html lang="en" class="min-h-full bg-gray-50 dark:bg-gray-900">
{{ template "head" . }}
<body>
    <div class="min-h-full bg-gray-50 dark:bg-gray-900">
        {{ template "header" . }}
        
        <div class="w-full">
            <div class="flex flex-col md:flex-row h-screen" x-data="{
                // State management
                moduleSlug: '{{ .ModuleSlug }}',
                lessonSlug: '{{ .LessonSlug }}',
                modules: {{ .InitialCourseData }},
                currentLesson: {{ .InitialLessonData }},
                currentModule: null,
                
                // Progress calculations
                completedLessons: 0,
                totalLessons: 0,
                completionPercentage: 0,
                
                // Initialize data
                init() {
                    // Defensive checks for initial data
                    if (!this.modules || typeof this.modules !== 'object') {
                        console.error('Initial course data is missing or invalid');
                        this.modules = { modules: [], completedCount: 0, totalCount: 0, progress: 0 };
                        // Try to fetch data if missing
                        this.fetchCourseStructure();
                    }
                    
                    if (!this.currentLesson || typeof this.currentLesson !== 'object') {
                        console.error('Initial lesson data is missing or invalid');
                        // Try to fetch lesson data if missing
                        if (this.moduleSlug && this.lessonSlug) {
                            this.fetchLessonData();
                        }
                    }
                    
                    // Set progress data from initial course data
                    this.completedLessons = this.modules.completedCount || 0;
                    this.totalLessons = this.modules.totalCount || 0;
                    this.completionPercentage = this.modules.progress || 0;
                    
                    // Find current module
                    if (this.modules.modules) {
                        this.currentModule = this.modules.modules.find(m => m.slug === this.moduleSlug);
                        
                        // Set initial expanded state for current module
                        if (this.currentModule) {
                            this.currentModule.expanded = true;
                        }
                    }
                    
                    // Expose triggerConfetti to make it globally available
                    window.triggerConfetti = this.triggerConfetti;

                    // Add keyboard navigation event listener
                    this.setupKeyboardNavigation();
                },
                
                // Set up keyboard navigation
                setupKeyboardNavigation() {
                    window.addEventListener('keydown', (e) => {
                        // Skip if user is typing in an input field
                        if (e.target.tagName === 'INPUT' || 
                            e.target.tagName === 'TEXTAREA' || 
                            e.target.isContentEditable) {
                            return;
                        }
                        
                        // Left arrow key for previous lesson
                        if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            this.navigateToPreviousLesson();
                        }
                        
                        // Right arrow key for next lesson
                        if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            this.navigateToNextLesson();
                        }
                    });
                },
                
                // Fetch course structure from API (only if needed)
                async fetchCourseStructure() {
                    try {
                        const response = await fetch('/masterclass/api/course-structure');
                        const data = await response.json();
                        this.modules = data.modules;
                        this.completedLessons = data.completedCount;
                        this.totalLessons = data.totalCount;
                        this.completionPercentage = data.progress;
                        
                        // Find current module
                        this.currentModule = this.modules.find(m => m.slug === this.moduleSlug);
                    } catch (error) {
                        console.error('Error fetching course structure:', error);
                    }
                },
                
                // Fetch current lesson data (only if needed)
                async fetchLessonData() {
                    try {
                        const response = await fetch(`/masterclass/api/lesson?moduleSlug=${this.moduleSlug}&lessonSlug=${this.lessonSlug}`);
                        const data = await response.json();
                        this.currentLesson = data;
                    } catch (error) {
                        console.error('Error fetching lesson data:', error);
                    }
                },
                
                // Toggle lesson completion status
                async toggleLessonComplete() {
                    if (!this.currentLesson) return;
                    
                    const endpoint = this.currentLesson.completed
                        ? '/masterclass/api/mark-incomplete'
                        : '/masterclass/api/mark-complete';
                    
                    try {
                        const response = await fetch(`${endpoint}?moduleSlug=${this.moduleSlug}&lessonSlug=${this.lessonSlug}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            // Update local state for the current lesson
                            const wasCompleted = this.currentLesson.completed;
                            this.currentLesson.completed = !wasCompleted;
                            
                            // Update module lessons and count completed lessons
                            let moduleCompletedCount = 0;
                            const foundModule = this.modules.modules.find(m => m.slug === this.moduleSlug);
                            
                            if (foundModule) {
                                // Find and update the lesson in the module
                                const lesson = foundModule.lessons.find(l => l.slug === this.lessonSlug);
                                if (lesson) {
                                    lesson.completed = !wasCompleted;
                                }
                                
                                // Count completed lessons in this module
                                moduleCompletedCount = foundModule.lessons.filter(l => l.completed).length;
                                foundModule.completed = moduleCompletedCount === foundModule.lessons.length;
                            }
                            
                            // Update global completion counts
                            if (wasCompleted) {
                                this.completedLessons--;
                            } else {
                                this.completedLessons++;
                            }
                            
                            // Update progress
                            if (this.totalLessons > 0) {
                                this.completionPercentage = (this.completedLessons / this.totalLessons) * 100;
                            }
                            
                            // Show confetti if completing
                            if (!wasCompleted) {
                                this.triggerConfetti();
                            }
                        }
                    } catch (error) {
                        console.error('Error toggling lesson completion:', error);
                    }
                },
                
                // Navigate to another lesson
                async navigateToLesson(moduleSlug, lessonSlug) {
                    if (moduleSlug === this.moduleSlug && lessonSlug === this.lessonSlug) {
                        return; // Already on this lesson
                    }
                    
                    try {
                        // Update URL without full page reload
                        history.pushState(
                            { moduleSlug, lessonSlug }, 
                            '', 
                            `/masterclass/${moduleSlug}/${lessonSlug}`
                        );
                        
                        // Fetch the new lesson data
                        const response = await fetch(`/masterclass/api/lesson?moduleSlug=${moduleSlug}&lessonSlug=${lessonSlug}`);
                        const lessonData = await response.json();
                        
                        // Update state
                        this.moduleSlug = moduleSlug;
                        this.lessonSlug = lessonSlug;
                        this.currentLesson = lessonData;
                        
                        // Find and update the current module
                        this.currentModule = this.modules.modules.find(m => m.slug === moduleSlug);
                        
                        // Set expanded state for the module
                        if (this.currentModule) {
                            // Make sure all modules are collapsed except current
                            this.modules.modules.forEach(m => {
                                m.expanded = (m.slug === moduleSlug);
                            });
                        }
                        
                        // Scroll to top of content
                        document.querySelector('.overflow-y-auto')?.scrollTo(0, 0);
                    } catch (error) {
                        console.error('Error navigating to lesson:', error);
                        // Fallback to traditional navigation on error
                        window.location.href = `/masterclass/${moduleSlug}/${lessonSlug}`;
                    }
                },
                
                // Trigger confetti effect
                triggerConfetti() {
                    setTimeout(() => {
                        try {
                            // Position confetti in center-top of screen
                            const x = 0.5;
                            const y = 0.3;
                            
                            confetti({
                                particleCount: 150,
                                spread: 90,
                                origin: { x, y }
                            });
                        } catch (error) {
                            console.error('Confetti error:', error);
                        }
                    }, 100);
                },
                
                // Navigate to next lesson
                async navigateToNextLesson() {
                    try {
                        const response = await fetch(`/masterclass/api/next-lesson?moduleSlug=${this.moduleSlug}&lessonSlug=${this.lessonSlug}`);
                        const data = await response.json();
                        
                        if (data.slug && data.moduleSlug) {
                            // Use client-side navigation instead of full page reload
                            await this.navigateToLesson(data.moduleSlug, data.slug);
                        }
                    } catch (error) {
                        console.error('Error fetching next lesson:', error);
                    }
                },
                
                // Navigate to previous lesson
                async navigateToPreviousLesson() {
                    try {
                        const response = await fetch(`/masterclass/api/previous-lesson?moduleSlug=${this.moduleSlug}&lessonSlug=${this.lessonSlug}`);
                        const data = await response.json();
                        
                        if (data.slug && data.moduleSlug) {
                            // Use client-side navigation instead of full page reload
                            await this.navigateToLesson(data.moduleSlug, data.slug);
                        }
                    } catch (error) {
                        console.error('Error fetching previous lesson:', error);
                    }
                }
            }">
                <!-- Include sidebar component -->
                {{ template "sidebar.html" . }}
                
                <!-- Main content area -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Lesson header -->
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                        <template x-if="currentLesson">
                            <div>
                                <div class="flex justify-between items-center">
                                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                                        <span x-text="currentLesson.emoji" class="mr-2"></span>
                                        <span x-text="currentLesson.title"></span>
                                    </h1>
                                    <button 
                                        @click="toggleLessonComplete"
                                        :class="currentLesson.completed 
                                            ? 'bg-green-600 text-white hover:bg-green-700' 
                                            : 'bg-[#81C895] text-white hover:bg-green-500 dark:bg-[#81C895] dark:text-white'"
                                        class="rounded-md px-4 py-2 text-sm font-semibold shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-400">
                                        <span x-text="currentLesson.completed ? 'Completed' : 'Mark as complete'"></span>
                                        <span x-show="currentLesson.completed">✅</span>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template x-if="!currentLesson">
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                                Loading lesson...
                            </h1>
                        </template>
                    </div>
                    
                    <!-- Lesson content -->
                    <template x-if="currentLesson">
                        <div class="mt-4 prose dark:prose-invert max-w-none">
                            <!-- Render lesson content -->
                            <div x-html="currentLesson.content"></div>
                        </div>
                    </template>
                    <template x-if="!currentLesson">
                        <div class="text-center p-12">
                            <p class="text-lg text-gray-600 dark:text-gray-400">Loading lesson content...</p>
                        </div>
                    </template>
                    
                    <!-- Lesson navigation -->
                    <template x-if="currentLesson">
                        <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex justify-center items-center space-x-4">
                                <button 
                                    @click="navigateToPreviousLesson"
                                    class="rounded-md px-4 py-2 text-sm font-semibold shadow-sm bg-[#E8EDF0] text-gray-800 hover:bg-gray-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-400">
                                    ⬅️ Previous lesson
                                </button>
                                
                                <button 
                                    @click="toggleLessonComplete"
                                    :class="currentLesson.completed 
                                        ? 'bg-green-600 text-white hover:bg-green-700' 
                                        : 'bg-[#81C895] text-white hover:bg-green-500 dark:bg-[#81C895] dark:text-white'"
                                    class="rounded-md px-4 py-2 text-sm font-semibold shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-400">
                                    <span x-text="currentLesson.completed ? 'Completed' : 'Mark as complete'"></span>
                                    <span x-show="currentLesson.completed">✅</span>
                                </button>
                                
                                <button 
                                    @click="navigateToNextLesson"
                                    class="rounded-md px-4 py-2 text-sm font-semibold shadow-sm bg-[#E8EDF0] text-gray-800 hover:bg-gray-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-400">
                                    Next lesson ➡️
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Wait for Alpine.js initialization
        document.addEventListener('alpine:init', () => {
            console.log('Alpine initialized, course UI ready');
        });
        
        // Handle browser back/forward navigation
        window.addEventListener('popstate', (event) => {
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 4 && pathParts[1] === 'masterclass') {
                const moduleSlug = pathParts[2];
                const lessonSlug = pathParts[3];
                
                // Get Alpine.js component and update it
                const component = document.querySelector('[x-data]').__x.$data;
                if (component && component.navigateToLesson) {
                    component.navigateToLesson(moduleSlug, lessonSlug);
                }
            }
        });
        
        // Add keyboard navigation support
        document.addEventListener('DOMContentLoaded', () => {
            window.addEventListener('keydown', (e) => {
                // Skip if user is typing in an input field
                if (e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'TEXTAREA' || 
                    e.target.isContentEditable) {
                    return;
                }
                
                setTimeout(() => {
                    // Access the Alpine.js component
                    const component = document.querySelector('.flex.flex-col.md\\:flex-row.h-screen').__x.$data;
                    if (!component) return;
                    
                    // Left arrow key for previous lesson
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        component.navigateToPreviousLesson();
                    }
                    
                    // Right arrow key for next lesson
                    if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        component.navigateToNextLesson();
                    }
                }, 0);
            });
        });
    </script>
</body>
</html> 
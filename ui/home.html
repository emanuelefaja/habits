<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Habits</title>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
    <script src="https://unpkg.com/@emoji-mart/data@latest/sets/14/native.json"></script>
    <script src="https://unpkg.com/emoji-mart@latest/dist/browser.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>      

    <script>
        // Initialize emoji-mart and create global search function
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize emoji-mart
                await EmojiMart.init({ data: await fetch('https://unpkg.com/@emoji-mart/data@latest/sets/14/native.json').then(r => r.json()) })
                
                // Create a global Alpine store for emoji functionality
                document.dispatchEvent(new CustomEvent('emoji-ready', {
                    detail: {
                        search: async (value) => {
                            if (!value) return []
                            const results = await EmojiMart.SearchIndex.search(value)
                            console.log('Search results:', results) // Debug log
                            return results
                        }
                    }
                }))
            } catch (error) {
                console.error('Error initializing emoji-mart:', error)
            }
        })
    </script>
</head>
<body class="h-full" 
      x-data="{ 
          modalState: { 
              isOpen: false, 
              view: 'suggestions', 
              selectedHabit: null, 
              customHabit: { 
                  name: '', 
                  emoji: '',
                  type: null 
              } 
          },
          formatNumericValue(value) {
              if (value >= 1000000) {
                  return Math.floor(value/100000)/10 + 'M';
              } else if (value >= 1000) {
                  return (value % 1000 === 0) ? 
                      Math.floor(value/1000) + 'k' : 
                      Math.floor(value/100)/10 + 'k';
              }
              return value;
          },
          emojiSearch: '',
          emojiResults: [],
          emojiSearchFn: null,
          
          // Initialize emoji search function when ready
          init() {
              document.addEventListener('emoji-ready', (e) => {
                  this.emojiSearchFn = e.detail.search
                  console.log('Emoji search initialized')
              })
          },
          
          // Modified search method
          async searchEmojis() {
              if (!this.emojiSearch || !this.emojiSearchFn) {
                  this.emojiResults = [];
                  return;
              }
              console.log('Searching for:', this.emojiSearch) // Debug log
              this.emojiResults = await this.emojiSearchFn(this.emojiSearch);
              console.log('Updated results:', this.emojiResults) // Debug log
          }
      }">
    {{ template "header" dict "User" .User "Page" "home" }}
    
    <div class="min-h-full flex flex-col" 
         x-data="{ 
            habits: {{ .HabitsJSON }},
            habitLogs: {},
            flashMessage: '',
            showFlash: false,

            // Month navigation state
            currentMonth: new Date().getMonth() + 1,
            currentYear: new Date().getFullYear(),
            monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'],
            isLoading: false,

            // Add this new method
            isToday(day) {
                const today = new Date();
                return today.getDate() === day && 
                       today.getMonth() + 1 === this.currentMonth && 
                       today.getFullYear() === this.currentYear;
            },

            // Get days in current month
            getDaysInMonth() {
                return new Date(this.currentYear, this.currentMonth, 0).getDate();
            },

            // Generate array of days for current month
            get daysArray() {
                return Array.from({ length: this.getDaysInMonth() }, (_, i) => i + 1);
            },

            // Format date string
            formatDate(day) {
                return `${this.currentYear}-${String(this.currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            },

            // Status cycling
            statusColors: {
                'none': '#ebedf0',
                'done': '#2da44e',
                'missed': '#E3211a',
                'skipped': '#00a0d2'
            },
            statusCycle: ['none', 'done', 'missed', 'skipped'],

            // Initialize with current month's logs
            async init() {
                await this.loadMonthLogs();
            },

            // Load habit logs for the current month
            async loadMonthLogs() {
                this.isLoading = true;
                try {
                    const startDate = this.formatDate(1);
                    const endDate = this.formatDate(this.getDaysInMonth());

                    // Clear existing logs for the month
                    this.habitLogs = {};

                    for (const habit of this.habits) {
                        const response = await fetch(`/api/habits/logs?habit_id=${habit.id}&start_date=${startDate}&end_date=${endDate}`);
                        const result = await response.json();
                        
                        if (result.success) {
                            result.data.forEach(log => {
                                const key = `${log.habit_id}_${log.date.split('T')[0]}`;
                                this.habitLogs[key] = log;
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading habit logs:', error);
                } finally {
                    this.isLoading = false;
                }
            },

            // Get status for a habit on a specific date
            getStatus(habitId, date) {
                const key = `${habitId}_${date}`;
                return this.habitLogs[key]?.status || 'none';
            },

            // Get color for a status
            getStatusColor(status) {
                return this.statusColors[status];
            },

            // Get next status in cycle
            getNextStatus(currentStatus) {
                const currentIndex = this.statusCycle.indexOf(currentStatus);
                return this.statusCycle[(currentIndex + 1) % this.statusCycle.length];
            },

            // Handle square click
            async handleSquareClick(habitId, date, status = null) {
                if (status) {
                    // For numeric habits, set value to 0 for missed/skipped
                    const habit = this.habits.find(h => h.id === habitId);
                    if (habit?.habit_type === 'numeric') {
                        fetch('/api/habits/logs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                habit_id: habitId,
                                date: date,
                                status: status,
                                value: { value: 0 }
                            })
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                const key = `${habitId}_${date}`;
                                this.habitLogs[key] = {
                                    habit_id: habitId,
                                    date: date,
                                    status: status,
                                    value: { String: JSON.stringify({ value: 0 }), Valid: true }
                                };
                                this.showTooltip = null;
                            }
                        });
                    } else {
                        // Binary habit with explicit status
                        fetch('/api/habits/logs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                habit_id: habitId,
                                date: date,
                                status: status
                            })
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                const key = `${habitId}_${date}`;
                                this.habitLogs[key] = {
                                    habit_id: habitId,
                                    date: date,
                                    status: status
                                };
                            }
                        });
                    }
                } else {
                    // Click-to-cycle logic for binary habits
                    const habit = this.habits.find(h => h.id === habitId);
                    if (habit?.habit_type === 'binary') {
                        const currentStatus = this.getStatus(habitId, date);
                        const nextStatus = this.getNextStatus(currentStatus);
                        
                        fetch('/api/habits/logs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                habit_id: habitId,
                                date: date,
                                status: nextStatus
                            })
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                const key = `${habitId}_${date}`;
                                this.habitLogs[key] = {
                                    habit_id: habitId,
                                    date: date,
                                    status: nextStatus
                                };
                            }
                        });
                    } else if (habit?.habit_type === 'numeric') {
                        this.showTooltip = `${habitId}_${date}`;
                        this.showNumericInput = false;
                    }
                }
            },

            // Add new data for suggestions
            showSuggestions: false,
            selectedSuggestions: [],
            habitSuggestions: [
                { emoji: '✨', name: 'Create your own', type: null }, // Special case for custom habit
                { emoji: '💪', name: 'Pushups', type: 'numeric' },
                { emoji: '🏃‍♂️', name: 'Running', type: 'binary' },
                { emoji: '🧘', name: 'Meditation', type: 'numeric' }, // minutes meditated
                { emoji: '📚', name: 'Reading', type: 'numeric' }, // pages or minutes
                { emoji: '💧', name: 'Drink Water', type: 'numeric' }, // glasses of water
                { emoji: '😴', name: '8h Sleep', type: 'binary' },
                { emoji: '🥗', name: 'Healthy Meal', type: 'binary' },
                { emoji: '📝', name: 'Journaling', type: 'binary' },
                { emoji: '🌅', name: 'Morning Routine', type: 'binary' },
                { emoji: '🎯', name: 'Practice Skill', type: 'binary' }
            ],

            async addSelectedHabits() {
                if (this.selectedSuggestions.length === 0) return;
                
                try {
                    const requestBody = this.selectedSuggestions.map(name => {
                        const suggestion = this.habitSuggestions.find(s => s.name === name);
                        console.log('Found suggestion:', suggestion);
                        const payload = {
                            name: suggestion.name,
                            emoji: suggestion.emoji,
                            habit_type: suggestion.type
                        };
                        console.log('Created payload:', payload);
                        return payload;
                    });
                    
                    console.log('Full request body:', requestBody);
                    
                    const response = await fetch('/api/habits/bulk', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('Response data:', result);
                    
                    if (result.success) {
                        // Fetch habits instead of full page reload
                        const habitsResponse = await fetch('/api/habits');
                        const habitsResult = await habitsResponse.json();
                        if (habitsResult.success) {
                            this.habits = habitsResult.data || [];
                            this.selectedSuggestions = [];
                            this.flashMessage = 'Habits added successfully';
                            this.showFlash = true;
                            setTimeout(() => this.showFlash = false, 3000);
                            await this.loadMonthLogs(); // Reload logs for new habits
                        }
                    } else {
                        this.flashMessage = 'Error adding habits';
                        this.showFlash = true;
                        setTimeout(() => this.showFlash = false, 3000);
                    }
                } catch (error) {
                    console.error('Error adding habits:', error);
                    this.flashMessage = 'Error adding habits';
                    this.showFlash = true;
                    setTimeout(() => this.showFlash = false, 3000);
                }
            },

            // Modal methods
            closeModal() {
                this.modalState.isOpen = false;
                this.modalState.view = 'suggestions';
                this.modalState.selectedHabit = null;
                this.modalState.customHabit.name = '';
                this.modalState.customHabit.emoji = '';
                this.modalState.customHabit.type = null;
            },

            createCustomHabit() {
                if (!this.modalState.customHabit.name || !this.modalState.customHabit.type) return;

                fetch('/api/habits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: this.modalState.customHabit.name,
                        emoji: this.modalState.customHabit.emoji,
                        habit_type: this.modalState.customHabit.type
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        this.habits.push(result.data);
                        this.habits.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
                        this.closeModal();
                        this.flashMessage = result.message;
                        this.showFlash = true;
                        setTimeout(() => this.showFlash = false, 3000);
                    } else {
                        this.flashMessage = result.message;
                        this.showFlash = true;
                        setTimeout(() => this.showFlash = false, 3000);
                    }
                })
                .catch(error => {
                    this.flashMessage = 'Error creating habit';
                    this.showFlash = true;
                    setTimeout(() => this.showFlash = false, 3000);
                });
            },

            showTooltip: null,
            showNumericInput: false,
            numericValue: 0,

            handleNumericSubmit(habitId, date, status = 'done') {
                fetch('/api/habits/logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        habit_id: habitId,
                        date: date,
                        status: status,
                        value: { value: parseInt(this.numericValue) }
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const key = `${habitId}_${date}`;
                        this.habitLogs[key] = {
                            habit_id: habitId,
                            date: date,
                            status: status,
                            value: { String: JSON.stringify({ value: parseInt(this.numericValue) }), Valid: true }
                        };
                        this.showTooltip = null;
                        this.showNumericInput = false;
                        this.numericValue = 0;
                    }
                });
            }
         }"
         @keydown.escape="closeModal()">

        <!-- Flash Message -->
        <div x-show="showFlash" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform translate-y-2"
             class="fixed bottom-4 right-4 px-4 py-2 rounded-md text-white"
             :class="flashMessage.includes('successfully') ? 'bg-green-500' : 'bg-red-500'"
             x-text="flashMessage">
        </div>

        <!-- Logout Button (Fixed at bottom center) -->
        <div class="fixed bottom-8 left-1/2 transform -translate-x-1/2">
            <button 
                @click="modalState.isOpen = true"
                class="rounded-md bg-[#2da44e] px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-[#2c974b] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#2da44e]">
                Create Habit ✨
            </button>
        </div>

        <!-- First Time User View -->
        {{ template "welcome" . }}

        <!-- Monthly Grid -->
        {{ template "monthly-grid" . }}

        <!-- New Habit Modal -->
        {{ template "habit-modal" . }}
    </div>
</body>
</html>
